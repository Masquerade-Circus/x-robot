(()=>{"use strict";var t=Object.defineProperty,e=Object.getOwnPropertyDescriptor,n=Object.getOwnPropertyNames,r=Object.prototype.hasOwnProperty,i={};((e,n)=>{for(var r in n)t(e,r,{get:n[r],enumerable:!0})})(i,{action:()=>D,context:()=>T,dangerState:()=>H,description:()=>L,getState:()=>J,guard:()=>R,immediate:()=>W,infoState:()=>N,initial:()=>_,invoke:()=>tt,machine:()=>S,nested:()=>F,nestedGuard:()=>C,parallel:()=>P,primaryState:()=>X,producer:()=>G,start:()=>et,state:()=>I,states:()=>z,successState:()=>q,transition:()=>M,warningState:()=>B});var a,o=(a=i,((i,a,o,u)=>{if(a&&"object"==typeof a||"function"==typeof a)for(let s of n(a))r.call(i,s)||s===o||t(i,s,{get:()=>a[s],enumerable:!(u=e(a,s))||u.enumerable});return i})(t({},"__esModule",{value:!0}),a)),u="__start__";function s(t){return null!==t&&"string"==typeof t&&t.trim().length>0}function l(t){return null!==t&&"object"==typeof t}function f(t){return l(t)&&"producer"in t}function c(t){return f(t)&&s(t.transition)}function h(t){return l(t)&&"action"in t}function d(t){return l(t)&&"immediate"in t}function m(t){return l(t)&&"guard"in t}function p(t){return m(t)&&"machine"in t}function y(t,e){return s(e)&&e in t.on}function g(t){return l(t)&&"machine"in t}function w(t){return g(t)&&s(t.transition)}function b(t){return l(t)&&Object.keys(t).every(t=>s(t))&&Object.values(t).every(t=>function(t){return l(t)&&"name"in t&&"run"in t&&"on"in t&&"args"in t}(t))}function j(t){return l(t)&&"description"in t}function v(t){return s(t)&&/^\w+\..+$/gi.test(t)}function x(t){return s(t)&&/^\w+\/.+$/gi.test(t)}function $(t){return d(t)&&v(t.immediate)}function A(t){return d(t)&&x(t.immediate)}function O(t){if("object"==typeof t&&null!==t&&!Object.isFrozen(t)){if(Array.isArray(t))for(let e=0,n=t.length;e<n;e++)O(t[e]);else for(let e in t)O(t[e]);Object.freeze(t)}return t}function k(t,e=new WeakMap){if(e.has(t))return e.get(t);if(null==t)return t;let n;if(Array.isArray(t))n=t.map(t=>k(t,e));else if("object"==typeof t){n={};for(let r in t)n[r]=k(t[r],e)}else if(t instanceof Date)n=new Date(t.getTime());else if(t instanceof Set)n=new Set(t);else{if(!(t instanceof Map))return t instanceof RegExp?new RegExp(t.source,t.flags):(n=t,n);{let r=Array.from(t,([t,n])=>[t,k(n,e)]);n=new Map(r)}}return e.set(t,n),n}function E(t,e,n){if(!s(n))throw new Error(`Invalid transition: ${n}`);let r=n.trim();if(r===u)return e.name===t.initial&&1===t.history.length;if(v(r)||x(r)){let n=v(r)?r.split("."):r.split("/"),i=n.shift(),a=v(r)?n.join("."):n.join("/");if(!i)return!1;if(i in t.parallel){let e=t.parallel[i];return E(e,e.states[e.current],a)}if(i!==e.name)return!1;if(0===e.nested.length)return!1;for(let t of e.nested)if(E(t.machine,t.machine.states[t.machine.current],a))return!0}return y(e,r)}function S(t,...e){let n={id:(r=t||"x-robot",r.toLowerCase().replace(/(\s|\W)/g,"")),title:t,states:{},context:{},initial:"",current:"",frozen:!0,isAsync:!1,history:[],parallel:{}};var r,i,a,o,u;for(let r of e){if(s(r)&&(t=r),b(r)&&(n.states={...n.states,...r}),l(u=r)&&"parallel"in u&&(n.parallel={...n.parallel,...r.parallel}),l(o=r)&&"context"in o){let t="function"==typeof r.context?r.context():r.context;if(!l(t))throw new Error("The context passed to the machine must be an object or a function that returns an object.");n.context={...n.context,...t}}l(a=r)&&"initial"in a&&(n.initial=r.initial,n.current=n.initial,n.history.push(`State: ${n.initial}`)),l(i=r)&&"freeze"in i&&(n.frozen=r.freeze)}n.frozen&&O(n.context);for(let t in n.states)if(n.states[t].run.length>0){if(n.states[t].run.find(h)){n.isAsync=!0;break}}if(!1===n.isAsync)for(let t in n.states)if(n.states[t].nested.length>0)for(let e of n.states[t].nested)if(e.machine.isAsync){n.isAsync=!0;break}if(!1===n.isAsync)for(let t in n.parallel)if(n.parallel[t].isAsync){n.isAsync=!0;break}return n}function z(...t){let e={};for(let n of t)e[n.name]=n;return e}function P(...t){let e={parallel:{}};for(let n of t)e.parallel[n.id]=n;return e}function T(t){return{context:t}}function _(t){return{initial:t}}function I(t,...e){let n,r=[],i={},a=[],o=[];for(let t=0;t<e.length;t++){let m=e[t];if(g(m))o.push(m);else if(h(m)||f(m)){if(r.push(m),h(m)){let t=s(m.success)?m.success:c(m.success)?m.success.transition:null;s(t)&&!1===y({on:i},t)&&(i[t]={transition:t,target:t,guards:[]});let e=s(m.failure)?m.failure:c(m.failure)?m.failure.transition:null;s(e)&&!1===y({on:i},e)&&(i[e]={transition:e,target:e,guards:[]})}}else if(d(m)){a.push(m);let t=m.immediate,e=m.guards;$(m)||A(m)||(i[t]={target:t,transition:t,guards:e})}else l(u=m)&&"transition"in u&&"target"in u?i[m.transition]=m:j(m)&&(n=m.description)}var u;return{name:t,nested:o,run:r,on:i,immediate:a,args:e,type:"default",description:n}}function M(t,e,...n){return{transition:t,target:e,guards:n}}function D(t,e,n){return{action:t,success:e,failure:n}}function R(t,e){return{guard:t,failure:e}}function G(t,e){return{producer:t,transition:e}}function W(t,...e){return{immediate:t,guards:e}}function C(t,e,n){return{guard:e,machine:t,failure:n}}function F(t,e){return{machine:t,transition:e}}function L(t){return{description:t}}function N(t,...e){let n=I(t,...e);return n.type="info",n}function X(t,...e){let n=I(t,...e);return n.type="primary",n}function q(t,...e){let n=I(t,...e);return n.type="success",n}function B(t,...e){let n=I(t,...e);return n.type="warning",n}function H(t,...e){let n=I(t,...e);return n.type="danger",n}function J(t,e){if(!function(t){return l(t)&&"states"in t&&"initial"in t&&"current"in t}(t))return null;if(!s(e)){let e={};if(Object.keys(t.parallel).length>0)for(let n in t.parallel)e[n]=J(t.parallel[n]);return s(t.current)&&(e.current=t.current),s(e.current)&&1===Object.keys(e).length?e.current:Object.keys(e).length>0?e:null}let n=e.split("."),r=n.shift();if(!s(r))return null;if(r in t.parallel)return J(t.parallel[r],n.join("."));if(r in t.states){let e={};for(let i of t.states[r].nested)e[i.machine.id]=J(i.machine,n.join("."));return 0===Object.keys(e).length?null:1===Object.keys(e).length?e[Object.keys(e)[0]]:e}let i=r;for(r in t.states)for(let e of t.states[r].nested)if(e.machine.id===i)return J(e.machine,n.join("."));return null}function K(t,e,n){if(f(e)){t.history.push(`Producer: ${e.producer.name}`);let r=t.context;t.frozen&&(r=k(r));let i=e.producer(r,n);if(l(i)&&(r=i),t.context=r,t.frozen&&O(t.context),c(e))return tt(t,e.transition)}else if(s(e))return tt(t,e)}async function Q(t,e,n){t.history.push(`Action: ${e.action.name}`);try{let r=await e.action(t.context,n);await K(t,e.success,r)}catch(n){if(!f(e.failure)&&!s(e.failure))throw n;await K(t,e.failure,n)}}function U(t){return t.fatal instanceof Error}function V(t,e,n){if(y(e,"error"))return tt(t,"error",n);if("fatal"in t.states)return t.current="fatal",void(t.fatal=n);throw t.fatal=n,n}function Y(t,e,n){if(0===e.nested.length)return;let r;t.isAsync&&(r=Promise.resolve());for(let t of e.nested)if(w(t)){let e=t.transition;r?r=r.then(()=>tt(t.machine,e,n)):tt(t.machine,e,n)}return r||void 0}function Z(t,e,n){if(0===e.immediate.length)return;let r=e.immediate,i=t.isAsync?Promise.resolve():null;for(let a of r){if(U(t))return;if(x(a.immediate)){let e=a.immediate.split("/"),r=e.shift(),o=e.join("/"),u=t.parallel[r];i?i=i.then(()=>tt(u,o,n)):tt(u,o,n)}else v(a.immediate)?i?i=i.then(()=>tt(t,a.immediate,n)):tt(t,a.immediate,n):i?i=i.then(async()=>{t.current===e.name&&await tt(t,a.immediate,n)}):t.current===e.name&&tt(t,a.immediate,n)}return i||void 0}function tt(t,e,n){if(U(t))return;if(!1===s(e))throw new Error(`Trying to invoke a transition with an invalid string: ${e}`);let r=e.trim();r===u&&(e=t.initial);let i=t.states[t.current];if(!E(t,i,r))throw new Error(`The transition '${r}' does not exist in the current state '${t.current}'`);if(x(r))return function(t,e,n){let r=e.split("/"),i=r.shift(),a=r.join("/");if(!i)throw new Error(`Invalid transition ${e}`);let o=t.parallel[i];if(!o)throw new Error(`Invalid transition ${e}`);return tt(o,a,n)}(t,r,n);if(v(r))return function(t,e,n){let r=e.split("."),i=r.shift(),a=r.join("."),o=t.isAsync?Promise.resolve():null;if(!i)return;let u=t.states[t.current];for(let t of u.nested){let e=t.machine,r=e.states[e.current];E(e,r,a)&&(o?o=o.then(()=>tt(e,a,n)):tt(e,a,n))}return o?o=o.then(()=>Z(t,u,n)):Z(t,u,n),o||void 0}(t,r,n);if(r!==u){t.history.push(`Transition: ${r}`);let e=i.on[r],a=function(t,e,n,r){for(let i=0;i<n.guards.length;i++){let a=n.guards[i];try{if(!m(a))return!1;let e;if(t.history.push(`Guard: ${a.guard.name}`),e=p(a)?a.guard(a.machine.context,r):a.guard(t.context,r),!0!==e)return f(a.failure)&&K(t,a.failure,e),!1}catch(n){return V(t,e,n),!1}}return!0}(t,i,e,n);if(!1===a)return void t.history.push(`State: ${i.name}`)}let a=r===u?t.initial:i.on[r].target;if(!1===s(a))throw new Error(`Trying to invoke a transition with an invalid target state: ${a}`);if(a in t.states==!1)throw new Error(`Invalid target state '${a}' for '${t.current}.${r}' transition`);let o=t.states[a];if(r!==u&&(t.current=a,t.history.push(`State: ${a}`)),t.isAsync){let e=Promise.resolve();return e=e.then(()=>Y(t,o,n)),e=e.then(()=>async function(t,e,n){for(let r=0;r<e.run.length;r++){let i=e.run[r];try{h(i)?await Q(t,i,n):f(i)&&await K(t,i,n)}catch(n){return void await V(t,e,n)}}}(t,o,n)),e=e.then(()=>Z(t,o,n)),e}Y(t,o,n),function(t,e,n){for(let r=0;r<e.run.length;r++){let i=e.run[r];try{f(i)&&K(t,i,n)}catch(n){V(t,e,n);break}}}(t,o,n),Z(t,o,n)}function et(t,e){if(!E(t,t.states[t.current],u))throw new Error("The machine has already been started.");return tt(t,u,e)}"undefined"!=typeof module?module.exports=o:self.XRobot=o})();//# sourceMappingURL=index.min.js.map